# üçø –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω–≤–µ–π–µ—Ä –¥–ª—è –î–æ–º–∞—à–Ω–µ–≥–æ –ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä–∞

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π ELT-–∫–æ–Ω–≤–µ–π–µ—Ä –¥–ª—è —Å–±–æ—Ä–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–±—ã—Ç–∏–π –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–∏–ª—å–º–æ–≤ –≤ –¥–æ–º–∞—à–Ω–µ–º –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–µ. –î–∞–Ω–Ω—ã–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è, –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∏ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å—Ç–µ–∫–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π.

## üõ†Ô∏è –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

* [Docker v4.22.1](https://www.docker.com/)
* [Postgres v13](https://www.postgresql.org/)
* [ClickHouse v23.8](https://clickhouse.com/)
* [Python v3.8](https://www.python.org/)
* [AirFlow v2.8.2](https://airflow.apache.org/)
* [DBT v1.8.0](https://www.getdbt.com/)
* [MetaBase v0.49.8](https://www.metabase.com/)
* [super-linter v5.7.2](https://github.com/super-linter/super-linter)

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç—Ç–∞–ø–æ–≤, –æ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏. –í–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –æ—Ä–∫–µ—Å—Ç—Ä—É–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é Apache Airflow.

–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

    Producer: Python-—Å–∫—Ä–∏–ø—Ç (generate_events.py), –∑–∞–ø—É—â–µ–Ω–Ω—ã–π –∫–∞–∫ –∑–∞–¥–∞—á–∞ –≤ Airflow, —ç–º—É–ª–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è (—Å—Ç–∞—Ä—Ç, –ø–∞—É–∑–∞, –ø—Ä–æ—Å–º–æ—Ç—Ä) –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏—Ö –≤ PostgreSQL.

    Ingestion & Replication: "–°—ã—Ä—ã–µ" —Å–æ–±—ã—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ PostgreSQL. –° –ø–æ–º–æ—â—å—é –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ (Publication/Subscription) –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –¥–∞–ª—å—à–µ.

    Loading to DWH: –û—Ç–¥–µ–ª—å–Ω—ã–π Python-—Å–µ—Ä–≤–∏—Å (ClickHouse Loader) –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –∏ –±–∞—Ç—á–∞–º–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Ö –≤ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ ClickHouse.

    Transformation: Airflow –∑–∞–ø—É—Å–∫–∞–µ—Ç dbt –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ ClickHouse. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –æ—á–∏—â–µ–Ω–Ω—ã–µ, –≥–æ—Ç–æ–≤—ã–µ –∫ –∞–Ω–∞–ª–∏–∑—É –≤–∏—Ç—Ä–∏–Ω—ã –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–µ—Å—Å–∏–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤).

    Visualization: Metabase –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ ClickHouse, –æ—Ç–∫—É–¥–∞ –∑–∞–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–∏—Ç—Ä–∏–Ω –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –¥–∞—à–±–æ—Ä–¥–æ–≤.

## –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Python

* dbt-core
* dbt-clickhouse
* python-decouple
* requests
* sqlalchemy
* datetime
* logging
* json

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ç–∏

–ö–∞–∫ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å, –≤ Docker Compose –≤—ã–¥–µ–ª–µ–Ω–æ 4 –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ç–µ–≤—ã—Ö —Å–µ–≥–º–µ–Ω—Ç–∞:

* data_postgres - —Å–µ—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ë–î PostgreSQL (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –≤ –¥–∞–Ω–Ω–æ–π —Å–µ—Ç–∏ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö)
* replication_network (192.168.1.0/24) - –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–µ–π
* click_net (192.168.2.0/24) - —Å–µ—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ClickHouse –∫ PostgreSQL. –ò–º–µ–Ω–Ω–æ –ø–æ –¥–∞–Ω–Ω–æ–π —Å–µ—Ç–∏ CH –±—É–¥–µ—Ç –≤—ã–∫–∞—á–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ PostgreSQL
* metanet (192.168.3.0/24) - —Å–µ—Ç—å, –ø–æ –∫–æ—Ç–æ—Ä–æ–π BI-—Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ —Ö—Ä–∞–Ω–∏–ª–∏—â—É –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –≤ –¥–∞–Ω–Ω–æ–π —Å–µ—Ç–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)

–°—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ —Å–µ—Ç—å –≤—ã–≥–ª—è–¥–∏—Ç —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

![–°—Ö–µ–º–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä–æ–≤](./pictures/network.png)

## –ó–∞–ø—É—Å–∫

–î–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–¥–µ–ª–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:

1. –í—ã–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã
    ```
    git clone git@github.com:horror-04/cinema-analize.git
    ```
2. –í –∫–∞—Ç–∞–ª–æ–≥–µ –ø—Ä–æ–µ–∫—Ç–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ñ–∞–π–ª .env_template –≤ .env, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã (–Ω–µ –º–µ–Ω—è–π—Ç–µ –∏–º–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, —Ç–∞–∫ –∫–∞–∫ –Ω–∞ –Ω–∏—Ö –µ—Å—Ç—å —Å—Å—ã–ª–∫–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ):
    ```
    AIRFLOW_UID=50000
    POSTGRES_PUBLICIST_USER=postgres
    POSTGRES_PUBLICIST_PASSWORD=postgres
    POSTGRES_PUBLICIST_DB=postgres_publicist
    
    POSTGRES_SUBSCRIPTION_USER=postgres
    POSTGRES_SUBSCRIPTION_PASSWORD=postgres
    POSTGRES_SUBSCRIPTION_DB=postgres_subscriber
    
    CLICKHOUSE_USER=username
    CLICKHOUSE_PASSWORD=username
    CLICKHOUSE_DB=my_database
    ```
    (–≤—ã—à–µ —É–∫–∞–∑–∞–Ω –ø—Ä–∏–º–µ—Ä –∑–∞–ø–æ–ª–µ–Ω–∏—è, –≤—ã –º–æ–∂–µ—Ç–µ –≤—Å—Ç–∞–≤–∏—Ç—å —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ)

3. –ó–∞–ø—É—Å—Ç–∏—Ç—å Docker –∏ –∫–æ–º–∞–Ω–¥–Ω—É—é –æ–±–æ–ª–æ—á–∫—É (—Ç–∞–∫ –∫–∞–∫ —è —Ä–∞–±–æ—Ç–∞—é –Ω–∞ –û–° Windows, –∫–æ–º–∞–Ω–¥–Ω–∞—è –æ–±–æ–ª–æ—á–∫–∞ —É –º–µ–Ω—è WSL)
4. –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ñ–∞–π–ª docker-compose.yaml
5. –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é –∫–æ–º–∞–Ω–¥—É:
    ```
        docker compose up -d
    ```
6. –ü–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤ –∏ –ø–æ–¥–Ω—è—Ç–∏—è –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –æ—Ç–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä –∏ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –≤ –ø–æ–∏—Å–∫–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ:
    ```
        localhost:8080
    ```
7. –ó–∞–π—Ç–∏ –≤ airflow (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å - airflow)

8. –ó–∞–ø—É—Å—Ç–∏—Ç—å DAG
9. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –Ω–æ–≤—É—é –≤–∫–ª–∞–¥–∫—É –∏ –ø—Ä–æ–ø–∏—Å–∞—Ç—å:
    ```
        localhost:3000
    ```
10. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏ —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π –¥–∞—à–±–æ—Ä–¥ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π.

